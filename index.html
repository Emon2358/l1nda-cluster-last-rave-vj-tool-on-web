<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXTREME CHAOS VJ MIXER</title>
    <style>
        body {
            background-color: #000;
            color: #f0f;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
            overflow-x: hidden;
        }
        h1 { 
            text-shadow: 2px 2px 0px #fff; 
            animation: shake 0.5s infinite;
        }
        
        /* æ¿€ã—ã„UI */
        .controls {
            background: #111;
            border: 2px solid #f0f;
            box-shadow: 0 0 15px #f0f;
            padding: 15px;
            width: 90%;
            max-width: 900px;
            margin-bottom: 20px;
            z-index: 10;
        }
        
        label { display: block; margin-top: 10px; color: #0ff; font-weight: bold; }
        input[type="file"] { margin-top: 5px; color: #fff; }
        
        button {
            background: #f0f;
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            width: 100%;
            text-transform: uppercase;
        }
        button:hover { background: #fff; color: #f0f; }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ */
        #canvas-container {
            position: relative;
            border: 5px solid #fff;
            box-shadow: 0 0 50px rgba(255, 0, 255, 0.5);
            max-width: 100%;
            line-height: 0;
        }
        canvas { width: 100%; height: auto; display: block; }
        
        .hidden-source { display: none; }
        
        #status { color: #ff0; margin-top: 10px; font-weight: bold; }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
    </style>
</head>
<body>

    <h1>âš ï¸ EXTREME CHAOS MIXER âš ï¸</h1>

    <div class="controls">
        <div style="color:red; font-weight:bold; border:1px solid red; padding:5px; margin-bottom:10px;">
            â€»è­¦å‘Š: ã“ã®ãƒ„ãƒ¼ãƒ«ã¯æ¿€ã—ã„å…‰ã®ç‚¹æ»…ï¼ˆã‚¹ãƒˆãƒ­ãƒœåŠ¹æœï¼‰ã‚’ä¼´ã„ã¾ã™ã€‚
        </div>

        <label>ã€TOP LAYERã€‘æ¿€ã—ãå´©å£Šã™ã‚‹å‹•ç”» (Local File Recommended)</label>
        <input type="file" id="fileTop" accept="video/*">
        
        <label>ã€BACKGROUNDã€‘ç•°æ¬¡å…ƒåŒ–ã™ã‚‹èƒŒæ™¯å‹•ç”» (Local File Recommended)</label>
        <input type="file" id="fileBot" accept="video/*">
        
        <label>ã€OVERLAYã€‘äº¡éœŠã®ã‚ˆã†ã«æµ®ã‹ã¶ç”»åƒ (Optional)</label>
        <input type="file" id="fileImg" accept="image/*">

        <button id="startBtn">ğŸ”¥ ACTIVATE CHAOS ğŸ”¥</button>
        <div id="status">WAITING FOR INPUT...</div>
    </div>

    <div id="canvas-container">
        <canvas id="mainCanvas"></canvas>
    </div>

    <video id="vidTop" class="hidden-source" loop muted playsinline crossorigin="anonymous"></video>
    <video id="vidBot" class="hidden-source" loop muted playsinline crossorigin="anonymous"></video>
    <img id="imgOverlay" class="hidden-source" crossorigin="anonymous">

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    const vidTop = document.getElementById('vidTop');
    const vidBot = document.getElementById('vidBot');
    const imgOverlay = document.getElementById('imgOverlay');
    const statusDiv = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');

    let isPlaying = false;
    
    // å¤‰æ•°
    let targetR = 0, targetG = 0, targetB = 0;
    let currentTolerance = 100;
    let hueRotate = 0;

    // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å‡¦ç†
    function handleFile(input, el, name) {
        input.addEventListener('change', (e) => {
            const f = e.target.files[0];
            if(f) {
                el.src = URL.createObjectURL(f);
                statusDiv.innerText = `${name} LOADED.`;
            }
        });
    }
    handleFile(document.getElementById('fileTop'), vidTop, "TOP VIDEO");
    handleFile(document.getElementById('fileBot'), vidBot, "BOTTOM VIDEO");
    handleFile(document.getElementById('fileImg'), imgOverlay, "IMAGE");

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆURLï¼ˆCORSåˆ¶é™ã§å‹•ã‹ãªã„å ´åˆãŒå¤šã„ã®ã§ãƒ•ã‚¡ã‚¤ãƒ«æ¨å¥¨ï¼‰
    const DEF_URL = "https://github.com/Emon2358/4949downloader/raw/main/downloads/sm2149860.mp4";

    startBtn.addEventListener('click', async () => {
        if(isPlaying) return;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«æœªæŒ‡å®šãªã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨
        if(!vidTop.src) vidTop.src = DEF_URL;
        if(!vidBot.src) vidBot.src = DEF_URL;

        try {
            await Promise.all([vidTop.play(), vidBot.play()]);
            
            canvas.width = vidTop.videoWidth || 640;
            canvas.height = vidTop.videoHeight || 360;
            
            statusDiv.innerText = "ğŸ”¥ğŸ”¥ PROCESSING CHAOS ğŸ”¥ğŸ”¥";
            statusDiv.style.color = "red";
            isPlaying = true;
            chaosLoop();
        } catch(e) {
            alert("å†ç”Ÿã‚¨ãƒ©ãƒ¼: å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ (CORSåˆ¶é™ã®å¯èƒ½æ€§)");
        }
    });

    function chaosLoop() {
        if(!isPlaying) return;
        requestAnimationFrame(chaosLoop);

        const w = canvas.width;
        const h = canvas.height;
        if(w===0) return;

        // --- 1. èƒŒæ™¯ã®æç”» (ã‚µã‚¤ã‚±ãƒ‡ãƒªãƒƒã‚¯å‡¦ç†) ---
        // æ¯å›è‰²ç›¸ã‚’å›è»¢ã•ã›ã‚‹ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‹ã‘ã‚‹
        hueRotate = (hueRotate + 15) % 360; // çˆ†é€Ÿå›è»¢
        ctx.filter = `invert(100%) hue-rotate(${hueRotate}deg) contrast(200%)`;
        ctx.drawImage(vidBot, 0, 0, w, h);
        ctx.filter = 'none'; // ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤

        // --- 2. æ‰‹å‰ã®å‹•ç”»ã®å‡¦ç† (æ¥µé™ã‚¯ãƒ­ãƒã‚­ãƒ¼) ---
        const tempC = document.createElement('canvas');
        tempC.width = w; tempC.height = h;
        const tCtx = tempC.getContext('2d', { willReadFrequently: true });
        tCtx.drawImage(vidTop, 0, 0, w, h);
        
        let frameData;
        try { frameData = tCtx.getImageData(0, 0, w, h); } catch(e) { return; }
        const d = frameData.data;
        const len = d.length;

        // â˜…â˜…â˜… æ¥µé™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š â˜…â˜…â˜…
        // æ¯ãƒ•ãƒ¬ãƒ¼ãƒ ã€ã‚¿ãƒ¼ã‚²ãƒƒãƒˆè‰²ã‚’å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ ã«å¤‰æ›´
        targetR = Math.random() * 255;
        targetG = Math.random() * 255;
        targetB = Math.random() * 255;

        // è¨±å®¹ç¯„å›²(Tolerance)ã‚’ã€Œ0(é€éãªã—)ã€ï½ã€Œ600(ã»ã¼å…¨é€é)ã€ã®é–“ã§æ¿€ã—ãä¹±é«˜ä¸‹ã•ã›ã‚‹
        // Math.random()ã®äºŒä¹—ã‚’ä½¿ã†ã“ã¨ã§ã€æ¥µç«¯ãªå€¤ï¼ˆå…¨æ¶ˆã—orå…¨æ®‹ã—ï¼‰ãŒå‡ºã‚„ã™ãã™ã‚‹
        const chaosFactor = Math.random(); 
        currentTolerance = chaosFactor * chaosFactor * 700; 

        // ãƒ”ã‚¯ã‚»ãƒ«æ“ä½œãƒ«ãƒ¼ãƒ—
        for(let i=0; i<len; i+=4) {
            // é«˜é€ŸåŒ–ã®ãŸã‚ãƒãƒ³ãƒãƒƒã‚¿ãƒ³è·é›¢
            const dist = Math.abs(d[i] - targetR) + Math.abs(d[i+1] - targetG) + Math.abs(d[i+2] - targetB);
            
            if(dist < currentTolerance) {
                d[i+3] = 0; // é€æ˜åŒ–
            } else {
                // é€éã•ã‚Œãªã‹ã£ãŸéƒ¨åˆ†ã‚‚ã€ãŸã¾ã«è‰²ã‚’ãƒã‚°ã‚‰ã›ã‚‹ï¼ˆã‚°ãƒªãƒƒãƒãƒã‚¤ã‚ºï¼‰
                if (Math.random() < 0.05) { // 5%ã®ç¢ºç‡ã§ãƒã‚¤ã‚º
                    d[i] = 255; // èµ¤ãé£›ã°ã™
                }
            }
        }

        // --- 3. åˆæˆ ---
        tCtx.putImageData(frameData, 0, 0);
        
        // ç”»é¢ã‚’æºã‚‰ã™æ¼”å‡ºï¼ˆãƒ©ãƒ³ãƒ€ãƒ ã‚ªãƒ•ã‚»ãƒƒãƒˆï¼‰
        const shakeX = (Math.random() - 0.5) * 20; // -10 ~ 10px
        const shakeY = (Math.random() - 0.5) * 20;
        
        ctx.drawImage(tempC, shakeX, shakeY);

        // --- 4. ç”»åƒã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ (ç‚¹æ»…ä»˜ã) ---
        if(imgOverlay.src && imgOverlay.complete) {
            // ã‚¢ãƒ«ãƒ•ã‚¡å€¤ã‚’é«˜é€Ÿç‚¹æ»…
            ctx.globalAlpha = Math.random() * 0.8; 
            // ç”»åƒã‚µã‚¤ã‚ºã‚’å¾®å¦™ã«å¤‰ãˆãªãŒã‚‰æç”»ï¼ˆãƒ–ãƒ¬ã‚¹åŠ¹æœï¼‰
            const scale = 1 + (Math.sin(Date.now() / 50) * 0.1);
            const iw = w * scale;
            const ih = h * scale;
            const ox = (w - iw) / 2;
            const oy = (h - ih) / 2;
            
            ctx.drawImage(imgOverlay, ox, oy, iw, ih);
            ctx.globalAlpha = 1.0;
        }
    }
</script>
</body>
</html>
