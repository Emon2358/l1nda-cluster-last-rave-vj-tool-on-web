<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIKI ATOMIZER VJ</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Courier New', monospace;
        }

        /* ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆå…¨ç”»é¢ï¼‰ */
        #canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 0;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« (ä¸‹éƒ¨) */
        .controls {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.85);
            border-top: 2px solid #0f0;
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 100;
            box-sizing: border-box;
            box-shadow: 0 -10px 30px rgba(0, 255, 0, 0.2);
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ é¡ */
        input[type="text"] {
            flex: 2;
            background: #111;
            border: 1px solid #444;
            color: #0f0;
            padding: 10px;
            font-size: 1.2rem;
            font-family: monospace;
            text-transform: uppercase;
        }
        input[type="text"]:focus { outline: none; border-color: #0f0; box-shadow: 0 0 10px #0f0; }

        button {
            flex: 1;
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px;
            font-size: 1.1rem;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
        }
        button:hover { background: #fff; }

        /* å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ (å³ä¸Šã®ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°) */
        .file-zone {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px dashed #fff;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-size: 0.8rem;
            z-index: 101;
            cursor: pointer;
            transition: 0.3s;
        }
        .file-zone:hover { background: #0f0; color: #000; border-color: #000; }
        input[type="file"] { display: none; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        #status {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #0f0; font-size: 3rem; font-weight: bold;
            display: none; text-shadow: 0 0 15px #0f0; z-index: 50;
            mix-blend-mode: hard-light;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <canvas id="mainCanvas"></canvas>
    </div>

    <div id="status">INITIALIZING...</div>

    <label class="file-zone">
        ğŸ“‚ LOAD MP4 VIDEO
        <input type="file" id="videoInput" accept="video/mp4,video/mov,video/webm">
    </label>

    <div class="controls">
        <input type="text" id="searchInput" placeholder="SEARCH CONCEPT (ex. UNIVERSE, CHAOS)" value="ãƒ•ãƒ©ã‚¯ã‚¿ãƒ«">
        <button id="searchBtn">DECONSTRUCT</button>
    </div>

    <video id="bgVideo" loop muted playsinline style="display:none;"></video>

<script>
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    const video = document.getElementById('bgVideo');
    const statusDiv = document.getElementById('status');
    const searchInput = document.getElementById('searchInput');

    // --- è¨­å®š ---
    const API_ENDPOINT = "https://ja.wikipedia.org/w/api.php";

    // --- çŠ¶æ…‹ç®¡ç† ---
    let charPool = []; // å–å¾—ã—ãŸå…¨æ–‡å­—ã®ãƒ—ãƒ¼ãƒ«
    let frame = 0;
    let isVideoLoaded = false;
    
    // åˆæœŸåŒ–
    resize();
    window.addEventListener('resize', resize);
    
    // æœ€åˆã®Wikiå–å¾—
    fetchWikiText("ãƒ•ãƒ©ã‚¯ã‚¿ãƒ«");
    
    requestAnimationFrame(renderLoop);

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    
    // 1. æ¤œç´¢å®Ÿè¡Œ
    document.getElementById('searchBtn').addEventListener('click', () => {
        fetchWikiText(searchInput.value);
    });
    searchInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') fetchWikiText(searchInput.value);
    });

    // 2. MP4ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
    document.getElementById('videoInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            video.src = url;
            video.play();
            isVideoLoaded = true;
            document.querySelector('.file-zone').innerText = "PLAYING: " + file.name;
        }
    });

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    // --- Wikipedia API: ãƒ†ã‚­ã‚¹ãƒˆã®ç´ ç²’å­åŒ– ---
    async function fetchWikiText(query) {
        if(!query) return;
        statusDiv.style.display = 'block';
        statusDiv.innerText = "ACCESSING HIVE MIND...";

        const params = new URLSearchParams({
            origin: '*',
            action: 'query',
            format: 'json',
            list: 'search',
            srsearch: query,
            srlimit: 1,
        });

        try {
            // ãƒšãƒ¼ã‚¸æ¤œç´¢
            const searchRes = await fetch(`${API_ENDPOINT}?${params}`);
            const searchData = await searchRes.json();
            
            if (!searchData.query.search.length) throw new Error("Not Found");
            const pageId = searchData.query.search[0].pageid;

            // æœ¬æ–‡å–å¾—
            const contentParams = new URLSearchParams({
                origin: '*',
                action: 'query',
                format: 'json',
                prop: 'extracts',
                pageids: pageId,
                explaintext: 1, // ãƒ—ãƒ¬ãƒ¼ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ã¿
            });

            const contentRes = await fetch(`${API_ENDPOINT}?${contentParams}`);
            const contentData = await contentRes.json();
            const rawText = contentData.query.pages[pageId].extract;

            // ã€é‡è¦ã€‘ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¸€æ–‡å­—ãšã¤åˆ†è§£ã—ã¦é…åˆ—åŒ–
            // ç©ºç™½ã‚„æ”¹è¡Œã‚’é™¤å»ã—ã€ç´”ç²‹ãªã€Œæ–‡å­—ã€ã®ãƒªã‚¹ãƒˆã«ã™ã‚‹
            charPool = rawText.replace(/\s+/g, '').split('');
            
            statusDiv.innerText = `LOADED ${charPool.length} PARTICLES`;
            setTimeout(() => statusDiv.style.display = 'none', 1500);

        } catch (e) {
            console.error(e);
            statusDiv.innerText = "DATA ERROR";
            setTimeout(() => statusDiv.style.display = 'none', 1000);
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (Psychedelic VJ Loop) ---
    function renderLoop() {
        requestAnimationFrame(renderLoop);
        frame++;

        const w = canvas.width;
        const h = canvas.height;
        const cx = w / 2;
        const cy = h / 2;

        // ==========================================
        // 1. æ˜ åƒã®ã‚µã‚¤ã‚±ãƒ‡ãƒªãƒƒã‚¯åŠ å·¥ (Feedback & Glitch)
        // ==========================================
        
        // (A) ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å‡¦ç†: ç”»é¢ã‚’æ¶ˆã•ãšã«å‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å¤‰å½¢ã—ã¦é‡ã­ã‚‹
        ctx.save();
        ctx.translate(cx, cy);
        
        // ã‚ºãƒ¼ãƒ ã¨å›è»¢: å‘¨æœŸçš„ã«ã†ã­ã‚‹ã‚ˆã†ãªå‹•ã
        const zoom = 1.01 + Math.sin(frame * 0.02) * 0.02; 
        const rotate = Math.sin(frame * 0.01) * 0.01;
        
        ctx.scale(zoom, zoom);
        ctx.rotate(rotate);
        ctx.translate(-cx, -cy);
        
        // æ®‹åƒã®é€éåº¦ (0.9ä»˜è¿‘ãŒè‰¯ã„æ„Ÿã˜ã«æº¶ã‘ã‚‹)
        ctx.globalAlpha = 0.92;
        ctx.drawImage(canvas, 0, 0);
        ctx.restore();

        // (B) å‹•ç”»ã®æç”» (åˆæˆãƒ¢ãƒ¼ãƒ‰ã§è‰²ã‚’ç ´å£Š)
        ctx.globalAlpha = 1.0;
        
        // åˆæˆãƒ¢ãƒ¼ãƒ‰: 'difference'(å·®åˆ†) ã¨ 'exclusion'(é™¤å¤–) ã‚’é«˜é€Ÿç‚¹æ»…ã§åˆ‡ã‚Šæ›¿ãˆ
        // ã“ã‚Œã«ã‚ˆã‚Šè‰²ãŒãƒã‚¬ãƒã‚¸åè»¢ã‚’ç¹°ã‚Šè¿”ã—ã€æ¿€ã—ã„è¦‹ãŸç›®ã«ãªã‚‹
        const blendMode = (frame % 20 < 10) ? 'difference' : 'exclusion';
        ctx.globalCompositeOperation = blendMode;

        // CSSãƒ•ã‚£ãƒ«ã‚¿é¢¨ã®è‰²ç›¸å›è»¢ã‚’Canvasã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã®ã¯é‡ã„ãŸã‚ã€
        // æç”»ã™ã‚‹å‹•ç”»ã®è‰²è‡ªä½“ã¯å¤‰ãˆãšã€èƒŒæ™¯ã¨ã®åˆæˆçµæœã§è‰²ã‚’å¤‰ãˆã‚‹
        
        if (isVideoLoaded && video.readyState >= 2) {
            // å‹•ç”»ã‚’ç”»é¢ã„ã£ã±ã„ã«æç”»
            ctx.drawImage(video, 0, 0, w, h);
        } else {
            // å‹•ç”»ãŒãªã„å ´åˆã¯ãƒã‚¤ã‚ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¡¨ç¤º
            if (frame % 5 === 0) {
                ctx.fillStyle = `hsl(${frame % 360}, 100%, 50%)`;
                ctx.fillRect(Math.random()*w, 0, Math.random()*100, h);
            }
        }

        // ==========================================
        // 2. æ–‡å­—ã®ç´ ç²’å­æç”» (Particle System)
        // ==========================================
        
        // é€šå¸¸ã®æç”»ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
        ctx.globalCompositeOperation = 'source-over';

        if (charPool.length > 0) {
            // 1ãƒ•ãƒ¬ãƒ¼ãƒ ã‚ãŸã‚Šã«ç™ºç”Ÿã•ã›ã‚‹æ–‡å­—æ•° (å¤šã„ã»ã©ã‚«ã‚ªã‚¹)
            const particlesPerFrame = 60; 

            for (let i = 0; i < particlesPerFrame; i++) {
                // æ–‡å­—ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ãƒ©ãƒ³ãƒ€ãƒ ã«æŠ½å‡º
                const char = charPool[Math.floor(Math.random() * charPool.length)];

                // ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®
                const x = Math.random() * w;
                const y = Math.random() * h;

                // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚µã‚¤ã‚º
                const size = Math.random() * 60 + 10; 

                ctx.font = `bold ${size}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // æ–‡å­—è‰²: æ¿€ã—ãç™ºå…‰ã•ã›ã‚‹
                const hue = (frame * 5 + Math.random() * 100) % 360;
                ctx.fillStyle = `hsl(${hue}, 100%, 60%)`;
                
                // æ–‡å­—ã®ç¸å–ã‚ŠåŠ¹æœ (ãƒã‚ªãƒ³é¢¨)
                ctx.shadowColor = `hsl(${hue}, 100%, 50%)`;
                ctx.shadowBlur = 20;

                ctx.fillText(char, x, y);
                
                // ãƒªã‚»ãƒƒãƒˆ
                ctx.shadowBlur = 0;
            }
        }

        // ==========================================
        // 3. ä»•ä¸Šã’ã®ã‚¹ãƒˆãƒ­ãƒœåŠ¹æœ
        // ==========================================
        // ä½ç¢ºç‡ã§ç”»é¢å…¨ä½“ã‚’ç™½ã‹é»’ã§ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã•ã›ã‚‹
        if (Math.random() < 0.03) {
            ctx.globalCompositeOperation = 'overlay';
            ctx.fillStyle = Math.random() > 0.5 ? '#fff' : '#000';
            ctx.fillRect(0, 0, w, h);
        }
    }
</script>
</body>
</html>
