<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WIKI ATOMIZER: EXTREME CHAOS EDITION</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Courier New', monospace;
        }

        #canvas-container {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 0;
            /* ç”»é¢å…¨ä½“ã«ã‚‚CSSã§è‰²ç›¸å›è»¢ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‹ã‘ã‚‹ */
            animation: hueRotate 10s linear infinite;
        }
        @keyframes hueRotate {
            from { filter: hue-rotate(0deg); }
            to { filter: hue-rotate(360deg); }
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« (ä¸‹éƒ¨) */
        .controls {
            position: fixed;
            bottom: 0; left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.85);
            border-top: 2px solid #f0f; /* ãƒ”ãƒ³ã‚¯ã«å¤‰æ›´ */
            padding: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
            z-index: 100;
            box-sizing: border-box;
            box-shadow: 0 -10px 50px rgba(255, 0, 255, 0.3);
        }

        input[type="text"] {
            flex: 2;
            background: #111;
            border: 1px solid #f0f;
            color: #f0f;
            padding: 10px;
            font-size: 1.2rem;
            font-family: monospace;
            text-transform: uppercase;
            text-shadow: 0 0 5px #f0f;
        }
        input[type="text"]:focus { outline: none; box-shadow: 0 0 20px #f0f; }

        button {
            flex: 1;
            background: #f0f;
            color: #000;
            border: none;
            padding: 10px;
            font-size: 1.1rem;
            font-weight: 900;
            cursor: pointer;
            text-transform: uppercase;
            box-shadow: 0 0 10px #f0f;
        }
        button:hover { background: #fff; color: #f0f; }

        /* å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ */
        .file-zone {
            position: fixed;
            top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px dashed #f0f;
            color: #f0f;
            padding: 20px;
            text-align: center;
            font-size: 0.9rem;
            font-weight: bold;
            z-index: 101;
            cursor: pointer;
            transition: 0.3s;
            text-shadow: 0 0 5px #f0f;
        }
        .file-zone:hover { background: #f0f; color: #000; }
        input[type="file"] { display: none; }

        #status {
            position: fixed; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #f0f; font-size: 4rem; font-weight: bold;
            display: none; text-shadow: 0 0 30px #f0f; z-index: 50;
            mix-blend-mode: difference;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="canvas-container">
        <canvas id="mainCanvas"></canvas>
    </div>

    <div id="status">INITIALIZING CHAOS...</div>

    <label class="file-zone">
        ğŸ“‚ DROP VIDEO HERE
        <input type="file" id="videoInput" accept="video/*">
    </label>

    <div class="controls">
        <input type="text" id="searchInput" placeholder="ENTER CONCEPT" value="ã‚«ã‚ªã‚¹ç†è«–">
        <button id="searchBtn">ATOMIZE</button>
    </div>

    <video id="bgVideo" loop muted playsinline style="display:none;"></video>

<script>
    const canvas = document.getElementById('mainCanvas');
    // willReadFrequentlyã‚’trueã«ã—ã¦ãƒ”ã‚¯ã‚»ãƒ«æ“ä½œã‚’æœ€é©åŒ–
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    const video = document.getElementById('bgVideo');
    const statusDiv = document.getElementById('status');
    const searchInput = document.getElementById('searchInput');

    const API_ENDPOINT = "https://ja.wikipedia.org/w/api.php";

    let charPool = [];
    let frame = 0;
    let isVideoLoaded = false;
    
    resize();
    window.addEventListener('resize', resize);
    
    // æœ€åˆã®å–å¾—
    fetchWikiText("ã‚«ã‚ªã‚¹ç†è«–");
    
    requestAnimationFrame(renderLoop);

    // --- ã‚¤ãƒ™ãƒ³ãƒˆ ---
    document.getElementById('searchBtn').addEventListener('click', () => {
        fetchWikiText(searchInput.value);
    });
    searchInput.addEventListener('keypress', (e) => {
        if(e.key === 'Enter') fetchWikiText(searchInput.value);
    });

    document.getElementById('videoInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            video.src = url;
            video.play();
            isVideoLoaded = true;
            document.querySelector('.file-zone').innerText = "PLAYING: " + file.name.substring(0, 15) + "...";
        }
    });
    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—å¯¾å¿œ
    const fileZone = document.querySelector('.file-zone');
    fileZone.addEventListener('dragover', (e) => { e.preventDefault(); fileZone.style.background = '#f0f'; fileZone.style.color = '#000'; });
    fileZone.addEventListener('dragleave', (e) => { e.preventDefault(); fileZone.style.background = 'rgba(0,0,0,0.6)'; fileZone.style.color = '#f0f'; });
    fileZone.addEventListener('drop', (e) => {
        e.preventDefault();
        fileZone.style.background = 'rgba(0,0,0,0.6)'; fileZone.style.color = '#f0f';
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('video/')) {
            video.src = URL.createObjectURL(file);
            video.play();
            isVideoLoaded = true;
            fileZone.innerText = "PLAYING: " + file.name.substring(0, 15) + "...";
        }
    });


    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }

    async function fetchWikiText(query) {
        if(!query) return;
        statusDiv.style.display = 'block';
        statusDiv.innerText = "DECONSTRUCTING...";

        const params = new URLSearchParams({
            origin: '*',
            action: 'query',
            format: 'json',
            list: 'search',
            srsearch: query,
            srlimit: 1,
        });

        try {
            const searchRes = await fetch(`${API_ENDPOINT}?${params}`);
            const searchData = await searchRes.json();
            if (!searchData.query.search.length) throw new Error("Not Found");
            const pageId = searchData.query.search[0].pageid;

            const contentParams = new URLSearchParams({
                origin: '*',
                action: 'query',
                format: 'json',
                prop: 'extracts',
                pageids: pageId,
                explaintext: 1,
            });

            const contentRes = await fetch(`${API_ENDPOINT}?${contentParams}`);
            const contentData = await contentRes.json();
            const rawText = contentData.query.pages[pageId].extract;

            // æ–‡å­—å˜ä½ã«åˆ†è§£
            charPool = rawText.replace(/\s+/g, '').split('');
            
            statusDiv.innerText = `${charPool.length} PARTICLES READY`;
            setTimeout(() => statusDiv.style.display = 'none', 1000);

        } catch (e) {
            console.error(e);
            statusDiv.innerText = "ERROR";
            setTimeout(() => statusDiv.style.display = 'none', 1000);
        }
    }

    // --- EXTREME RENDER LOOP ---
    function renderLoop() {
        requestAnimationFrame(renderLoop);
        frame++;

        const w = canvas.width;
        const h = canvas.height;
        const cx = w / 2;
        const cy = h / 2;

        // =================================================
        // 1. æ–‡å­—ã®ç´ ç²’å­æç”» (æ¿€ã—ãæºã‚‰ã—ã¦ç™ºå…‰ã•ã›ã‚‹)
        // =================================================
        // èƒŒæ™¯å‡¦ç†ã®ã€Œå‰ã€ã«æç”»ã™ã‚‹ã“ã¨ã§ã€æ–‡å­—ã‚‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«å·»ãè¾¼ã‚€
        
        // åˆæˆãƒ¢ãƒ¼ãƒ‰: lighter (åŠ ç®—ç™ºå…‰) ã§å…‰ã‚‰ã›ã‚‹
        ctx.globalCompositeOperation = 'lighter';

        if (charPool.length > 0) {
            // ç™ºç”Ÿé‡ã‚’å¢—ã‚„ã™
            const particlesPerFrame = 80; 

            for (let i = 0; i < particlesPerFrame; i++) {
                const char = charPool[Math.floor(Math.random() * charPool.length)];
                
                // åŸºæœ¬ä½ç½®
                const baseX = Math.random() * w;
                const baseY = Math.random() * h;
                
                // ã€æ¿€åŒ–ã€‘ä½ç½®ã‚¸ãƒƒã‚¿ãƒ¼ (æ¿€ã—ãæºã‚‰ã™)
                const jitter = 30; // æºã‚Œå¹…
                const x = baseX + (Math.random() - 0.5) * jitter;
                const y = baseY + (Math.random() - 0.5) * jitter;

                const size = Math.random() * 80 + 10; 

                ctx.font = `900 ${size}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';

                // è‰²: é«˜å½©åº¦ã®ãƒã‚ªãƒ³ã‚«ãƒ©ãƒ¼
                const hue = (frame * 10 + Math.random() * 360) % 360;
                ctx.fillStyle = `hsla(${hue}, 100%, 60%, ${Math.random()*0.8 + 0.2})`;
                
                // å¼·ã„ç™ºå…‰ãƒ–ãƒ©ãƒ¼
                ctx.shadowColor = `hsl(${hue}, 100%, 50%)`;
                ctx.shadowBlur = 30;

                ctx.fillText(char, x, y);
                
                ctx.shadowBlur = 0;
            }
        }


        // =================================================
        // 2. æ¥µé™ã‚µã‚¤ã‚±ãƒ‡ãƒªãƒƒã‚¯èƒŒæ™¯ (è‰²åå·®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯)
        // =================================================
        
        ctx.save();
        ctx.translate(cx, cy);
        
        // ã€æ¿€åŒ–ã€‘ã‚ºãƒ¼ãƒ ã¨å›è»¢ã®é€Ÿåº¦ã‚¢ãƒƒãƒ—
        const zoom = 1.02 + Math.sin(frame * 0.03) * 0.03; 
        const rotate = Math.sin(frame * 0.02) * 0.03;
        ctx.scale(zoom, zoom);
        ctx.rotate(rotate);
        ctx.translate(-cx, -cy);

        // æ®‹åƒã®æ¿ƒã• (å°‘ã—ä¸Šã’ã¦ãƒ‰ãƒ­ãƒ‰ãƒ­æ„Ÿã‚’å¼·ã‚ã‚‹)
        ctx.globalAlpha = 0.94;

        // ã€æ–°æ©Ÿèƒ½ã€‘RGBè‰²åå·® (ãƒãƒ£ãƒ³ãƒãƒ«ãšã‚‰ã—) åŠ¹æœ
        // ç”»é¢ã‚’3å›ã€è‰²ã‚’å¤‰ãˆã¦å°‘ã—ãšã‚‰ã—ã¦é‡ã­ã‚‹ã“ã¨ã§è™¹è‰²ã®æ»²ã¿ã‚’ä½œã‚‹
        const shift = Math.sin(frame * 0.05) * 10; // ãšã‚‰ã—å¹…

        // Red Channel
        ctx.globalCompositeOperation = 'screen'; // ã‚¹ã‚¯ãƒªãƒ¼ãƒ³åˆæˆã§é‡ã­ã‚‹
        ctx.fillStyle = '#f00'; // èµ¤ã§å¡—ã‚Šã¤ã¶ã™ï¼ˆå®Ÿéš›ã¯drawImageã®è‰²æˆåˆ†ï¼‰
        ctx.drawImage(canvas, shift, 0);
        
        // Blue Channel
        ctx.fillStyle = '#00f';
        ctx.drawImage(canvas, -shift, 0);
        
        // Green Channel (ä¸­å¿ƒ)
        ctx.fillStyle = '#0f0';
        ctx.drawImage(canvas, 0, shift);

        ctx.restore();


        // =================================================
        // 3. å‹•ç”»ã®åˆæˆ (æš´èµ°ãƒ¢ãƒ¼ãƒ‰)
        // =================================================
        ctx.globalAlpha = 1.0;
        
        // ã€æ¿€åŒ–ã€‘åˆæˆãƒ¢ãƒ¼ãƒ‰ã®é¸æŠè‚¢ã‚’å¢—ã‚„ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ åˆ‡æ›¿
        const blendModes = ['difference', 'exclusion', 'hard-light', 'overlay', 'color-dodge'];
        // é«˜é€Ÿã§åˆ‡ã‚Šæ›¿ãˆã‚‹
        ctx.globalCompositeOperation = blendModes[frame % blendModes.length];
        
        if (isVideoLoaded && video.readyState >= 2) {
            ctx.drawImage(video, 0, 0, w, h);
        } else {
            // å‹•ç”»ãŒãªã„æ™‚ã®æ¿€ã—ã„ãƒã‚¤ã‚º
            if (frame % 3 === 0) {
                ctx.fillStyle = `hsl(${Math.random()*360}, 100%, 50%)`;
                ctx.fillRect(Math.random()*w, 0, Math.random()*200, h);
            }
        }

        // =================================================
        // 4. ä»•ä¸Šã’ã®ã‚¹ãƒˆãƒ­ãƒœ (é »åº¦ã‚¢ãƒƒãƒ—)
        // =================================================
        if (Math.random() < 0.05) {
            ctx.globalCompositeOperation = 'overlay';
            ctx.fillStyle = Math.random() > 0.5 ? '#fff' : '#000';
            ctx.fillRect(0, 0, w, h);
        }
    }
</script>
</body>
</html>
